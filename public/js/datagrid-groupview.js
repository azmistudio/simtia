$.extend($.fn.datagrid.defaults,{groupHeight:28,expanderWidth:30,groupSortOrder:null,groupStyler:function(r,t){return""},groupSorter:function(r,t){var e=r.value,a=t.value;return e==a?0:e>a?1:-1}});var groupview=$.extend({},$.fn.datagrid.defaults.view,{render:function(r,t,e){for(var a=[],d=this.groups,o=0;o<d.length;o++)a.push(this.renderGroup.call(this,r,o,d[o],e));$(t).html(a.join(""))},renderGroup:function(r,t,e,a){var d=$.data(r,"datagrid"),o=d.options,i=$(r).datagrid("getColumnFields",a),n=o.frozenColumns&&o.frozenColumns.length;if(a&&!o.rownumbers&&!n)return"";var s=[],l=function(r,t){var e="",a="";"string"==typeof r?a=r:r&&(e=r.class||"",a=r.style||"");return'class="'+t+(e?" "+e:"")+'" style="'+a+'"'}(c=o.groupStyler.call(r,e.value,e.rows),"datagrid-group");s.push("<div group-index="+t+" "+l+">"),(a&&(o.rownumbers||o.frozenColumns.length)||!a&&!o.rownumbers&&!o.frozenColumns.length)&&(s.push('<span class="datagrid-group-expander">'),s.push('<span class="datagrid-row-expander datagrid-row-collapse">&nbsp;</span>'),s.push("</span>")),(a&&n||!a)&&(s.push('<span class="datagrid-group-title">'),s.push(o.groupFormatter.call(r,e.value,e.rows)),s.push("</span>")),s.push("</div>");var p=$.extend([],e.rows);if(o.groupFooter){var g=o.groupFooter.call(r,e.value,e.rows);g&&(g._group_footer=!0,p.push(g))}s.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var u=e.startIndex,h=0;h<p.length;h++){var c,f="",v="";"string"==typeof(c=o.rowStyler?o.rowStyler.call(r,u,p[h]):"")?v=c:c&&(f=c.class||"",v=c.style||"");var w='class="datagrid-row '+(u%2&&o.striped?"datagrid-row-alt ":" ")+f+'"';p[h]._group_footer&&(w='class="datagrid-group-footer"',v="height:"+(o.editorHeight+1)+"px");var x=v?'style="'+v+'"':"",b=d.rowIdPrefix+"-"+(a?1:2)+"-"+u;s.push('<tr id="'+b+'" datagrid-row-index="'+u+'" '+w+" "+x+">"),s.push(this.renderRow.call(this,r,i,a,u,p[h])),s.push("</tr>"),u++}return s.push("</tbody></table>"),s.join("")},bindEvents:function(r){var t=$.data(r,"datagrid").dc,e=t.body1.add(t.body2),a=($.data(e[0],"events")||$._data(e[0],"events")).click[0].handler;e.unbind("click").bind("click",function(t){var e=$(t.target).closest("span.datagrid-row-expander");if(e.length){var d=e.closest("div.datagrid-group").attr("group-index");e.hasClass("datagrid-row-collapse")?$(r).datagrid("collapseGroup",d):$(r).datagrid("expandGroup",d)}else a(t)})},onBeforeRender:function(r,t){var e=$.data(r,"datagrid"),a=e.options;$("#datagrid-group-style").length||$("head").append('<style id="datagrid-group-style">.datagrid-group{height:'+a.groupHeight+"px;overflow:hidden;font-weight:bold;border-bottom:1px solid #ccc;white-space:nowrap;word-break:normal;}.datagrid-group-title,.datagrid-group-expander{display:inline-block;vertical-align:bottom;height:100%;line-height:"+a.groupHeight+"px;padding:0 4px;}.datagrid-group-title{position:relative;}.datagrid-group-expander{width:"+a.expanderWidth+"px;text-align:center;padding:0}.datagrid-group-expander .datagrid-row-expander{margin:"+Math.floor((a.groupHeight-16)/2)+"px 0;display:inline-block;width:16px;height:16px;cursor:pointer}.datagrid-group-footer .datagrid-cell-rownumber{display:none}</style>");for(var d=[],o=0;o<t.length;o++){var i=t[o];(l=g(i[a.groupField]))?l.rows.push(i):(l={value:i[a.groupField],rows:[i]},d.push(l))}a.groupSortOrder&&d.sort(function(t,e){return a.groupSorter.call(r,t,e)*("asc"==a.groupSortOrder?1:-1)});var n=0,s=[];for(o=0;o<d.length;o++){var l;(l=d[o]).startIndex=n,n+=l.rows.length,s=s.concat(l.rows)}e.data.rows=s,this.groups=d;var p=this;function g(r){for(var t=0;t<d.length;t++){var e=d[t];if(e.value==r)return e}return null}setTimeout(function(){p.bindEvents(r)},0)},onAfterRender:function(r){$.fn.datagrid.defaults.view.onAfterRender.call(this,r);var t=this,e=$.data(r,"datagrid"),a=e.options;e.onResizeColumn||(e.onResizeColumn=a.onResizeColumn),e.onResize||(e.onResize=a.onResize),a.onResizeColumn=function(a,d){t.resizeGroup(r),e.onResizeColumn.call(r,a,d)},a.onResize=function(a,d){t.resizeGroup(r),e.onResize.call($(r).datagrid("getPanel")[0],a,d)},t.resizeGroup(r)}});$.extend($.fn.datagrid.methods,{groups:function(r){return r.datagrid("options").view.groups},expandGroup:function(r,t){return r.each(function(){var r=$(this).datagrid("options"),e=$.data(this,"datagrid").dc.view.find(null!=t?'div.datagrid-group[group-index="'+t+'"]':"div.datagrid-group"),a=e.find("span.datagrid-row-expander");a.hasClass("datagrid-row-expand")&&(a.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse"),e.next("table").show()),$(this).datagrid("fixRowHeight"),r.onExpandGroup&&r.onExpandGroup.call(this,t)})},collapseGroup:function(r,t){return r.each(function(){var r=$(this).datagrid("options"),e=$.data(this,"datagrid").dc.view.find(null!=t?'div.datagrid-group[group-index="'+t+'"]':"div.datagrid-group"),a=e.find("span.datagrid-row-expander");a.hasClass("datagrid-row-collapse")&&(a.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand"),e.next("table").hide()),$(this).datagrid("fixRowHeight"),r.onCollapseGroup&&r.onCollapseGroup.call(this,t)})},scrollToGroup:function(r,t){return r.each(function(){var r=$.data(this,"datagrid").dc,e=r.body2.children('div.datagrid-group[group-index="'+t+'"]');if(e.length){var a=e.outerHeight(),d=r.view2.children("div.datagrid-header")._outerHeight(),o=r.body2.outerHeight(!0)-r.body2.outerHeight(),i=e.position().top-d-o;i<0?r.body2.scrollTop(r.body2.scrollTop()+i):i+a>r.body2.height()-18&&r.body2.scrollTop(r.body2.scrollTop()+i+a-r.body2.height()+18)}})},refreshGroupTitle:function(r,t){return r.each(function(){$(this).datagrid("options").view.refreshGroupTitle(this,t)})}}),$.extend(groupview,{refreshGroupTitle:function(r,t){var e=$.data(r,"datagrid"),a=e.options,d=e.dc,o=this.groups[t];d.body1.add(d.body2).children("div.datagrid-group[group-index="+t+"]").find("span.datagrid-group-title").html(a.groupFormatter.call(r,o.value,o.rows))},resizeGroup:function(r,t){var e=$.data(r,"datagrid"),a=e.dc,d=a.header2.find("table").find("tr.datagrid-filter-row"),o=a.body2.children("table.datagrid-btable:first").width();if(null==t)var i=a.body2.children("div.datagrid-group");else i=a.body2.children("div.datagrid-group[group-index="+t+"]");i._outerWidth(o);var n=e.options;if(n.frozenColumns&&n.frozenColumns.length){var s=a.view1.width()-n.expanderWidth,l="rtl"==a.view1.css("direction").toLowerCase();i.find(".datagrid-group-title").css(l?"right":"left",-s+"px")}d.length&&n.showFilterBar&&d.show()},insertRow:function(r,t,e){var a,d=$.data(r,"datagrid"),o=d.options,i=d.dc,n=null;if(d.data.rows.length){for(var s=0;s<this.groups.length;s++)if(this.groups[s].value==e[o.groupField]){n=this.groups[s],a=s;break}n?(null!=t&&null!=t||(t=d.data.rows.length),t<n.startIndex?t=n.startIndex:t>n.startIndex+n.rows.length&&(t=n.startIndex+n.rows.length),$.fn.datagrid.defaults.view.insertRow.call(this,r,t,e),t>=n.startIndex+n.rows.length&&(l(t,!0),l(t,!1)),n.rows.splice(t-n.startIndex,0,e)):(n={value:e[o.groupField],rows:[e],startIndex:d.data.rows.length},a=this.groups.length,i.body1.append(this.renderGroup.call(this,r,a,n,!0)),i.body2.append(this.renderGroup.call(this,r,a,n,!1)),this.groups.push(n),d.data.rows.push(e)),this.setGroupIndex(r),this.refreshGroupTitle(r,a),this.resizeGroup(r)}else $(r).datagrid("loadData",[e]);function l(t,e){var a=e?1:2,d=o.finder.getTr(r,t-1,"body",a);o.finder.getTr(r,t,"body",a).insertAfter(d)}},updateRow:function(r,t,e){var a=$.data(r,"datagrid").options;$.fn.datagrid.defaults.view.updateRow.call(this,r,t,e);var d=a.finder.getTr(r,t,"body",2).closest("table.datagrid-btable"),o=parseInt(d.prev().attr("group-index"));this.refreshGroupTitle(r,o)},deleteRow:function(r,t){var e=$.data(r,"datagrid"),a=e.options,d=e.dc,o=d.body1.add(d.body2),i=a.finder.getTr(r,t,"body",2).closest("table.datagrid-btable"),n=parseInt(i.prev().attr("group-index"));$.fn.datagrid.defaults.view.deleteRow.call(this,r,t);var s=this.groups[n];if(s.rows.length>1)s.rows.splice(t-s.startIndex,1),this.refreshGroupTitle(r,n);else{o.children("div.datagrid-group[group-index="+n+"]").remove();for(var l=n+1;l<this.groups.length;l++)o.children("div.datagrid-group[group-index="+l+"]").attr("group-index",l-1);this.groups.splice(n,1)}this.setGroupIndex(r)},setGroupIndex:function(r){for(var t=0,e=0;e<this.groups.length;e++){var a=this.groups[e];a.startIndex=t,t+=a.rows.length}}});